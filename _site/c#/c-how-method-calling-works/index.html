<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>[C#] How method calling works &#8211; Site Title</title>
<meta name="description" content="Site description for the metas.">
<meta name="keywords" content="c#, clr">



<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="[C#] How method calling works">
<meta property="og:description" content="Site description for the metas.">
<meta property="og:url" content="http://localhost:4000/c%23/c-how-method-calling-works">
<meta property="og:site_name" content="Site Title">
<meta property="og:image" content="http://localhost:4000/images/some-image.jpg">





<link rel="canonical" href="http://localhost:4000/c%23/c-how-method-calling-works">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Site Title Feed">
<link rel="author" href="http://plus.google.com/123123123123132123?rel=author">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/style.css" />

<div class="search-wrapper">
    <div class="search-form">
        <input type="text" class="search-field" placeholder="Search...">
        <i class="icon-remove-sign"></i>
        <ul class="search-results post-list"></ul><!-- /.search-results -->
    </div><!-- /.search-form -->
</div><!-- ./search-wrapper -->




<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>
<body class="post-template" itemscope itemtype="http://schema.org/WebPage">  

<header id="masthead" class="blog-background overlay align-center align-middle animated from-bottom"  style="background-image: url(http://localhost:4000/images/some-image.jpg)" itemscope itemtype="http://schema.org/Organization">


    <div class="inner">
        <div class="container">
            <a class="brand" href="/" role="banner" itemprop="url">

                <img itemprop="logo" src="http://localhost:4000/images/site-logo.png" alt="Site Title Logo" />

            <h1 class="blog-title light" itemprop="name">
                Site Title
            </h1>
                
            </a>
        </div>
    </div>
    
    
    <div class="decor-wrapper">
        <svg id="header-decor" class="decor bottom" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 100" preserveAspectRatio="none">
            <path class="large left" d="M0 0 L50 50 L0 100" fill="rgba(255,255,255, .1)"></path>
            <path class="large right" d="M100 0 L50 50 L100 100" fill="rgba(255,255,255, .1)"></path>

            <path class="medium left" d="M0 100 L50 50 L0 33.3" fill="rgba(255,255,255, .3)"></path>
            <path class="medium right" d="M100 100 L50 50 L100 33.3" fill="rgba(255,255,255, .3)"></path>

            <path class="small left" d="M0 100 L50 50 L0 66.6" fill="rgba(255,255,255, .5)"></path>
            <path class="small right" d="M100 100 L50 50 L100 66.6" fill="rgba(255,255,255, .5)"></path>

            <path d="M0 99.9 L50 49.9 L100 99.9 L0 99.9" fill="rgba(255,255,255, 1)"></path>

            <path d="M48 52 L50 49 L52 52 L48 52" fill="rgba(255,255,255, 1)"></path>

        </svg>
    </div>
    
</header>
<div id="main" class="content" role="main" itemprop="mainContentOfPage" itemscope itemtype="http://schema.org/Blog">
    <div class="container">
        <div class="row">
            <article class="post col-md-8 col-md-offset-2 hentry" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
            
            
            
                
            
             
             
                    <header class="post-header entry-header">
                        
                        <h1 class="post-title text-center hyper lighter bordered-bottom entry-title" itemprop="headline">[C#] How method calling works</h1>
                        
                        <div class="post-info text-center small">
                            <span class="entry-date date published updated"><time datetime="2013-12-15T00:00:00+00:00" class="post-time" itemprop="datePublished">15 Dec 2013</time><span>
                            in <span class="post-tags"><a href="http://localhost:4000/categories/index.html#c#" data-toggle="tooltip" title="Other posts from the C# category" rel="tag">C#</a></span>&nbsp;<span class="post-tags"><i class="icon-time"></i>&nbsp;8 minutes read</span>
                        </div>
                    </header>
                    <div class="post-body bordered-bottom" itemprop="description">
                        
                        <p>Method calling is a joint operation performed by the C# compiler and the CLR. As we will see in this article, the role of each can vary depending on the context in which the method is called.</p>

<h2 id="the-type-object">The type object</h2>

<p>The key to understanding the basics of method calling in C# is understanding how the CLR manages types. For every type used in a program, the CLR maintains a corresponding type object on the managed heap which includes pretty much everything the runtime needs to know in regards to a given type. One of the things that the type object contains is a method table, which the runtime can query to determine which methods are implemented by a given type and where in the assembly the method implementation code can be found. The method table is indispensable when making virtual method calls, and as such the runtime must be able to access it quickly and easily. To make this possible, every object present on the managed heap contains what is known as a type object pointer, which provides the runtime with direct access to the type object for a given type.</p>

<h2 id="polymorphism-and-virtual-methods">Polymorphism and virtual methods</h2>

<p>Although it may seem strange to have begun this article looking at virtual method calls instead of nonvirtual calls, most method calls in a given C# program are made virtually, including many made to nonvirtual methods. <a href="http://www.levibotelho.com/call-and-callvirt-in-cil/">We discussed this in depth in a recent article which looked at the difference between the call and callvirt CIL instructions</a>.</p>

<p>Now then, down to business. In order to understand how the C# compiler and the CLR handle virtual method calls, we’ll use the following program as an example.</p>

<div class="highlight"><pre><code class="csharp"><span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">GetString</span><span class="p">(</span><span class="s">&quot;Hello World&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">string</span> <span class="nf">GetString</span><span class="p">(</span><span class="kt">object</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">arg</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>This is a classic case of polymorphism. Although within the context of GetString() ToString() is being called on an object, the implementation of ToString() that is called is that defined by System.String. But how does this work? The first step in the process is performed by the C# compiler. If we were to look at the code for this program, we would see that arg.ToString() is called with a “callvirt” instruction. This instructs the CLR to call ToString() virtually.</p>

<p>What actually happens is that when ToString() is called, the runtime accesses arg’s type object via its type object pointer. Because arg is really a string, the type object for System.String will be accessed. The runtime will then access the type object’s method table and see that it System.String provides an implementation for ToString(). It will then access the method code, compile it if necessary, and execute it.</p>

<p>On the other hand, if we passed an object to GetString() that did not provide an implementation of ToString(), the CLR would simply begin walking up the inheritance tree, checking each ancestor type until it found one which did. This is made possible because each type object contains a reference to its parent type. An inheritance chain is therefore created for every type in a .NET program which in every case leads back to System.Object.</p>

<h2 id="value-types">Value types</h2>

<p>Although brilliantly designed, the above algorithm for making virtual method calls has one important weakness. It is entirely dependent on the type object, and therefore the type object pointer. So then what happens if we call a method on a value type which is not necessarily represented on the managed heap, and therefore may not contain a type object pointer? Well, as is often the case the best way to find out is by writing a small test program.</p>

<div class="highlight"><pre><code class="csharp"><span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">sb</span> <span class="p">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="p">(</span><span class="s">&quot;Hello world.&quot;</span><span class="p">);</span>
    <span class="n">sb</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
    <span class="m">6.</span><span class="n">ToString</span><span class="p">();</span>
    <span class="n">GetString</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
    <span class="n">GetString</span><span class="p">(</span><span class="m">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">string</span> <span class="nf">GetString</span><span class="p">(</span><span class="kt">object</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">arg</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">string</span> <span class="nf">GetString</span><span class="p">(</span><span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">arg</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>Let’s start by looking at the IL for the two calls to ToString().</p>

<div class="highlight"><pre><code class="text">// StringBuilder
IL_000c:  callvirt   instance string [mscorlib]System.Object::ToString()
// ...
// Int32
IL_001a:  call       instance string [mscorlib]System.Int32::ToString()
</code></pre></div>

<p>When ToString() is called on the StringBuilder instance, we can see that on the IL level, we are calling ToString() polymorphically on System.Object. Because StringBuilder is a reference type, the runtime will use the type object to navigate to the correct implementation of ToString(), and the code will function as anticipated. In this case, the C# compiler hasn’t done a whole lot and has left it up to the CLR to determine which method to invoke.</p>

<p>This changes considerably, however, when we call ToString() on System.Int32, a value type which does not have an integrated a type object pointer. In this case, the C# compiler has instructed the CLR to make a nonvirtual call to the implementation of ToString() that is written directly into System.Int32. The CLR therefore doesn’t need to access the type object. It simply follows the instructions that the C# compiler has given it.</p>

<p>Now let’s look at what happens when we call GetString(), which takes an object as a parameter and returns the result of calling ToString() on the object. The first thing we need to do is to look at the IL for the GetString method.</p>

<div class="highlight"><pre><code class="text">.method private hidebysig static string  GetString(object arg) cil managed
{
  // Code size       7 (0x7)
  .maxstack  8
  IL_0000:  ldarg.0
  IL_0001:  callvirt   instance string [mscorlib]System.Object::ToString()
  IL_0006:  ret
} // end of method Program::GetString
</code></pre></div>

<p>As the C# compiler cannot know ahead of time on what type ToString() will really be called, it simply instructs the CLR to make a virtual method call to ToString() and lets the CLR determine which implementation to invoke. This is exactly the same code that we saw when we called ToString() directly on our instance of StringBuilder earlier on. It should therefore come as no surprise that when we pass a StringBuilder to GetString, the StringBuilder is simply loaded onto the stack and the GetString() method is invoked like so.</p>

<div class="highlight"><pre><code class="text">  IL_0024:  ldloc.0
  IL_0025:  call       string ConsoleApplication1.Program::GetString(object)
</code></pre></div>

<p>As our instance of StringBuilder lives on the heap, when executing GetString() the CLR use the StringBuilder’s type object pointer to access its type object’s method tables and will invoke the correct implementation of ToString().</p>

<p>But what will happen when we pass an Int32 to GetString()?</p>

<div class="highlight"><pre><code class="text">  IL_002f:  ldc.i4.6
  IL_0030:  box        [mscorlib]System.Int32
  IL_0035:  call       string ConsoleApplication1.Program::GetString(object)
</code></pre></div>

<p>Aha! In order to make this call, the compiler has gone ahead and boxed our Int32 before passing it as an argument to GetString(). During the boxing, a type object pointer will have been created and embedded in the object’s implementation on the heap. When ToString() is invoked on our Int32 in the context of GetString(), the CLR will be able to use this type object pointer to find the correct implementation of ToString() to execute</p>

<h2 id="a-quick-summary">A quick summary…</h2>

<p>Hopefully this article will have provided you with some insight into how method calls are handled in C#. To sum up, here are the main take-away points:</p>

<ul>
<li>Method calls are handled jointly by the C# compiler and the CLR</li>
<li>Virtual method calls, which are the most common type of method call in C#, are made possible primarily by the CLR and the type object corresponding to the variable on which the method is being called.</li>
<li>Nonvirtual method calls are handled in large part by the C# compiler, and require considerably less CLR magic behind the scenes.</li>
</ul>
<p>## But what about the boxing?!</p>

<p>If you’re a regular reader of this blog, you’ll know that I love writing about how to avoid unnecessary boxing operations. I couldn’t leave this post without taking a final moment to look at how to avoid the type of boxing that we saw when we passed our Int32 to our GetString(object) method. The truth is that avoiding the boxing is incredibly simple. You simply need to provide a method overload for any value types that you reasonably expect to pass to the method. In fact, you’ll see this trick used fairly frequently in the .NET Framework. Console.WriteLine() is a good example. In the case of passing an Int32 to our GetString method, we would simply need to provide an overload such as this.</p>

<div class="highlight"><pre><code class="csharp"><span class="k">static</span> <span class="kt">string</span> <span class="nf">GetString</span><span class="p">(</span><span class="kt">int</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">arg</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>

<p>If we were to look at the IL for this method, we would see that ToString would be called on System.Int32 and not on System.Object. This assertion is made by the compiler, and is logically valid for two reasons:</p>

<ol>
<li>We cannot pass a less-derived type (i.e. an object) to GetString(int).</li>
<li>We cannot pass a type derived from Int32 to this method, because value types do not support inheritance. </li>
</ol>
<p>As the only type of parameter that can be passed to this method is an Int32, the compiler can therefore instruct the CLR to call Int32’s implementation of ToString() with no ill effects.</p>

                        <br>
                    <span class="entry-tags">
                    <p>
                        <i class="icon-tags"></i>&nbsp;Tagged with <a href="http://localhost:4000/tags/index.html#c#" data-toggle="tooltip" title="Posts tagged with c#" rel="tag">c#</a>&nbsp;&bull;&nbsp;<a href="http://localhost:4000/tags/index.html#clr" data-toggle="tooltip" title="Posts tagged with clr" rel="tag">clr</a>
                    </p>
                    </span>
                    </div>
        </div>
                    <footer class="post-footer entry-meta">
                        <div class="post-share text-center">
    <p class="light small">
        Share this post
    </p>
    <ul class="social-mini">
        <li>
            <a href="https://twitter.com/intent/tweet?text=&quot;[C#] How method calling works&quot;%20http://localhost:4000/c%23/c-how-method-calling-works%20via%20&#64;"
            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" data-toggle="tooltip" title="Share on Twitter" itemprop="Twitter">
                <i class="icon-twitter"></i>
            </a>
        </li>
        <li>
            <a  href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/c%23/c-how-method-calling-works"
            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" data-toggle="tooltip" title="Share on Facebook" itemprop="Facebook">
                <i class="icon-facebook"></i>
            </a>
        </li>
        <li>
            <a href="https://plus.google.com/share?url=http://localhost:4000/c%23/c-how-method-calling-works"
           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;" data-toggle="tooltip" title="Share on Google plus" itemprop="GooglePlus">
                <i class="icon-google-plus"></i>
            </a>
        </li>
    </ul>
</div>
                        <div class="post-author text-center">                       
	        <img src="http://localhost:4000/images/your-photo.jpg" alt="Your Name's photo" itemprop="image" class="post-avatar img-circle img-responsive"/>    
	    <h4 class="bordered-bottom vcard author" itemprop="author" itemscope itemtype="http://schema.org/Person">By <span itemprop="name" class="fn"><a href="http://localhost:4000/about" title="About Your Name" itemprop="url">Your Name</a></span></h4>
	    <p>Some Details about yourself</p>
</div> 
                        <div id="disqus_thread"></div><!-- /#disqus_thread -->
                    </footer>
            </article>
    </div>
</div>

<footer id="footer"  class="blog-background overlay text-center align-middle animated from-top" style="background-image: url(http://localhost:4000/images/some-image.jpg)" >


    <div class="inner">
        <div class="container">

            <ul class="social-icons">
            
            
            
            <li>
                <a href="http://plus.google.com/123123123123132123" data-toggle="tooltip" title="Your Name on Google+" target="_blank">
                    <i class="icon-google-plus"></i>
                </a>
            </li>
            
            
            
            
            
        </ul>
            <p class="copy-text">
                <a href="http://localhost:4000/about/">Your Name</a> &copy; 2014 &bull; All rights reserved.
            </p>
            <p class="copy-text">
                Powered by <a href="http://jekyllrb.com">Jekyll</a> using the <i class="icon-heart"></i> <a href="http://alum.mit.edu/www/hmfaysal/">HMFAYSAL OMEGA</a> theme.
            </p>
            <ul class="menu-items">
            
            <li>
                
                    <a href="http://localhost:4000/"><i class="icon-home"></i></a>&nbsp;&bull;
                 
            </li>
            
            <li>
                
                    <a href="http://localhost:4000/documentation"><i class="icon-book"></i> Documentation</a>&nbsp;&bull;
                 
            </li>
            
            <li>
                
                    <a href="http://localhost:4000/categories">Categories</a>&nbsp;&bull;
                 
            </li>
            
            <li>
                
                    <a href="http://localhost:4000/tags">Tags</a>&nbsp;&bull;
                 
            </li>
            
            <li>
                
                    <a href="http://localhost:4000/hossain-mohd-faysal">Faysal who?</a>&nbsp;&bull;
                 
            </li>
            
            <li><a href="http://localhost:4000/feed.xml" title="Atom/RSS feed"><i class="icon-rss"></i> Feed</a></li>
            &nbsp;&bull;<li class="dosearch"><i class="icon-search"></i> Search</li>
        </ul>
        </div>
    </div>
    
        <div class="decor-wrapper">
            <svg id="footer-decor" class="decor top" xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 100 100" preserveAspectRatio="none">

                <path class="large left" d="M0 0 L50 50 L0 100" fill="rgba(255,255,255, .1)"></path>
                <path class="large right" d="M100 0 L50 50 L100 100" fill="rgba(255,255,255, .1)"></path>

                <path class="medium left" d="M0 0 L50 50 L0 66.6" fill="rgba(255,255,255, .3)"></path>
                <path class="medium right" d="M100 0 L50 50 L100 66.6" fill="rgba(255,255,255, .3)"></path>

                <path class="small left" d="M0 0 L50 50 L0 33.3" fill="rgba(255,255,255, .5)"></path>
                <path class="small right" d="M100 0 L50 50 L100 33.3" fill="rgba(255,255,255, .5)"></path>

                <path d="M0 0 L50 50 L100 0 L0 0" fill="rgba(255,255,255, 1)"></path>

                <path d="M48 48 L50 51 L52 48 L48 48" fill="rgba(255,255,255, 1)"></path>

            </svg>
        </div>
    
</footer>

    
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>
    <script type="text/javascript" src="http://localhost:4000/assets/js/waypoints.min.js"></script>
    <script type="text/javascript" src="http://localhost:4000/assets/js/script.js"></script>


<!-- Jekyll Simple Search option -->
<script>
  $(document).ready(function() {
      $('.search-field').simpleJekyllSearch({
          jsonFile : 'http://localhost:4000/search.json',
          searchResults : '.search-results',
          template : '<li><article><a href="{url}">{title} <span class="entry-date"><time datetime="{date}">{shortdate}</time></span></a></article></li>',
          noResults: '<p>Nothing found.</p>'
        });
  });

  (function( $, window, undefined ) {
    
     var bs = {
          close: $(".icon-remove-sign"),
          searchform: $(".search-form"),
          canvas: $("body"),
          dothis: $('.dosearch')
      };
    
    bs.dothis.on('click', function() {
      $('.search-wrapper').css({ display: "block" });
      bs.searchform.toggleClass('active');
      bs.searchform.find('input').focus();
      bs.canvas.toggleClass('search-overlay');
    });
    
      bs.close.on('click', function() {
        $('.search-wrapper').removeAttr( 'style' );
        bs.searchform.toggleClass('active');
        bs.canvas.removeClass('search-overlay');
    });
  })( jQuery, window );
</script>


<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'shortname'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> 
</body>
</html>